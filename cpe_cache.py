#!/usr/bin/env python3
# coding=utf-8

from core.cpe import CPEManager
from core.cve import CVEManager

while True:
    cve_entries = sorted([f["name"] for f in CVEManager().stream_from_file()], reverse=True)
    entry_count = len(cve_entries)

    cpe_manager = CPEManager()
    cpe_manager.load_cache_from_disk()

    try:
        for index, cve_entry in enumerate(cve_entries, start=1):
            print(f"\rFetching {index}/{entry_count}... ({cve_entry})", end="", flush=True)
            cpe_manager.get(cve_entry)
    finally:
        print("\nFlushing...")
        cpe_manager.flush_cache_to_disk()
